apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ cookiecutter.project_slug }}-dev
  namespace: dev
  labels:
    app: {{ cookiecutter.project_slug }}-dev
    component: development
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ cookiecutter.project_slug }}-dev
  template:
    metadata:
      labels:
        app: {{ cookiecutter.project_slug }}-dev
        component: development
    spec:
      containers:
        - name: dev-container
          image: {{ cookiecutter.project_slug }}-dev:latest
          ports:
            - containerPort: 3000
              name: web-ui
            - containerPort: 8080
              name: api-server
            - containerPort: 8000
              name: vllm-api
            - containerPort: 8443
              name: https
          env:
            - name: KUBECONFIG
              value: "/home/vscode/.kube/config"
          volumeMounts:
            - name: workspace
              mountPath: /workspaces/{{ cookiecutter.project_slug }}
            - name: kube-config
              mountPath: /home/vscode/.kube
              readOnly: true
            - name: ssh-keys
              mountPath: /home/vscode/.ssh
              readOnly: true
            - name: aws-config
              mountPath: /home/vscode/.aws
              readOnly: true
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
      volumes:
        - name: workspace
          persistentVolumeClaim:
            claimName: {{ cookiecutter.project_slug }}-dev-workspace
        - name: kube-config
          secret:
            secretName: kube-config
        - name: ssh-keys
          secret:
            secretName: ssh-keys
        - name: aws-config
          secret:
            secretName: aws-config
---
apiVersion: v1
kind: Service
metadata:
  name: {{ cookiecutter.project_slug }}-dev-service
  namespace: dev
  labels:
    app: {{ cookiecutter.project_slug }}-dev
spec:
  selector:
    app: {{ cookiecutter.project_slug }}-dev
  ports:
    - name: web-ui
      port: 3000
      targetPort: 3000
      protocol: TCP
    - name: api-server
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: vllm-api
      port: 8000
      targetPort: 8000
      protocol: TCP
    - name: https
      port: 8443
      targetPort: 8443
      protocol: TCP
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ cookiecutter.project_slug }}-dev-ingress
  namespace: dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - dev.example.com
      secretName: dev-tls
  rules:
    - host: dev.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ cookiecutter.project_slug }}-dev-service
                port:
                  number: 3000
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ cookiecutter.project_slug }}-dev-workspace
  namespace: dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: local-path
---
apiVersion: v1
kind: Secret
metadata:
  name: kube-config
  namespace: dev
type: Opaque
data:
  # This will be populated with base64 encoded kubeconfig
  config: ""
---
apiVersion: v1
kind: Secret
metadata:
  name: ssh-keys
  namespace: dev
type: Opaque
data:
  # This will be populated with base64 encoded SSH keys
  id_rsa: ""
  id_rsa.pub: ""
---
apiVersion: v1
kind: Secret
metadata:
  name: aws-config
  namespace: dev
type: Opaque
data:
  # This will be populated with base64 encoded AWS credentials
  config: ""
  credentials: ""
